@using ProductionManagementSystem.Core.Models.Users
@using ProductionManagementSystem.Core.Models.AltiumDB
@model ProductionManagementSystem.WEB.Models.AltiumDB.EntityDataListViewModel

@{
  ViewBag.Title = Model.Table?.DisplayName ?? "Все компоненты";
  Layout = "_AltiumDBLayout";
  List<string> columns = Model.Table?.TableColumns?.Where(x => x.Display)?.Select(x => x.ColumnName).ToList() ?? AltiumDbEntity.Fields;
  columns = columns.Where(x => AltiumDbEntity.DefaultDisplayFalse.All(y => y != x)).ToList();
  columns.AddRange(new List<string>(){"Quantity"});
  
  if (!User.IsInRole(RoleEnum.Engineer))
    columns = columns.Where(x => !x.Contains("Ref", StringComparison.CurrentCultureIgnoreCase)).ToList();

  if (User.Identity is {IsAuthenticated: false })
    columns = columns.Where(x => !x.Contains("Quantity", StringComparison.CurrentCultureIgnoreCase)).ToList();
  
}

<div class="bx--data-table-container " data-table>
<form method="get" action="" id="tableFiltersForm">
  @if (Model.Table != null)
  {
    <input type="hidden" name="tableId" value="@(Model.Table.Id)">
  }
  @if (Model.Pagination != null)
    {
      <input type="hidden" name="page" value="@(Model.Pagination.CurrentPage)">
      <input type="hidden" name="itemPerPage" value="@(Model.Pagination.ItemPerPage)">
    }
  <div class="bx--data-table-header">
    <div class="bx--grid bx--grid--full-width">
      <div class="bx--row bx--row-padding">
        <div class="bx--col-lg-12">
          <h4 class="bx--data-table-header__title">@ViewBag.Title</h4>
        </div>
      </div>
      <div class="bx--row">
        <div class="bx--col-lg-12">
          <div class="bx--grid">
            <div class="bx--row">
              @foreach (var filter in Model.Filters)
              {
                <div class="bx--col-lg-2">
                  <fieldset class="bx--fieldset" style="max-height: 200px; overflow: auto">
                    <legend class="bx--label">@filter.FilterName</legend>
                    @foreach (var value in filter.Values)
                    {
                      <div class="bx--form-item bx--checkbox-wrapper">
                        <input id="bx--checkbox-@filter.FilterName-@value.value" class="bx--checkbox" type="checkbox" value="@value.value"
                               name="@filter.FilterName" @(value.selected ? "checked" : "")>
                        <label for="bx--checkbox-@filter.FilterName-@value.value" class="bx--checkbox-label">@value.text</label>
                      </div>
                    }
                  </fieldset>
                </div>
              }
            </div>
            <div class="bx--row">
              <div class="bx--col--auto" style="display: flex; justify-content: end">
                <button
                  class="bx--btn bx--btn--tertiary bx--btn--sm"
                  type="reset" onclick="location.href ='@Url.Action("Index", Model.Table != null ? new {tableId = Model.Table.Id} : new {})'">
                  Сбросить фильтр
                </button>
                <button
                  class="bx--btn bx--btn--tertiary bx--btn--sm"
                  type="submit">
                  Применить фильтр
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <section class="bx--table-toolbar  bx--table-toolbar--small ">
    <div class="bx--toolbar-content">
      <partial name="Partail/CarbonUIComponents/SearchInTableSm"></partial>
      @if (User.IsInRole(RoleEnum.AltiumDBEntitiesAdmin))
      {
        <button type="button" class="bx--btn bx--btn--sm bx--btn--primary" onclick="location.href='@Url.Action("Create", Model.Table != null ? new {tableId = Model.Table.Id} : new {})'">
          Создать компонент
          <svg focusable="false" preserveAspectRatio="xMidYMid meet" style="will-change: transform;" xmlns="http://www.w3.org/2000/svg" class="bx--btn__icon" width="20" height="20" viewBox="0 0 32 32" aria-hidden="true">
            <path d="M17 15L17 7 15 7 15 15 7 15 7 17 15 17 15 25 17 25 17 17 25 17 25 15 17 15z"></path>
          </svg>
        </button>
      }
    </div>
  </section>
</form>

<!-- End Toolbar Content -->
<!-- Table -->
<table class="bx--data-table  bx--data-table--sort bx--data-table--visible-overflow-menu bx--data-table--compact">
  <thead>
  <tr>
    <th></th>
    @foreach (var columnName in columns)
    {
      <partial name="Partail/CarbonUIComponents/SortableTh" model="columnName"/>
    }
    @if (User.IsInRole(RoleEnum.AltiumDBEntitiesAdmin))
    {
      <th style="width: 30px"></th>
    }
  </tr>
  </thead>
  <tbody>
  @for (int i = 0; i < Model.Data.Count; i++)
  {
    <tr >
      <td>
        <img src="@Model.Data[i].ImageUrl" class="altiumdb--entity-table--image"/>
      </td>

      @foreach (var columnName in columns)
      {
        <td>
          @if (columnName == "Item")
          {
            <a asp-action="Details" asp-route-id="@Model.Data[i].KeyId" target="_blank">@Model.Data[i][columnName]</a>
          }
          else
          {
            <span style="white-space: pre-line">@Model.Data[i][columnName]</span>
          }
        </td>
      }
      @if (User.IsInRole(RoleEnum.AltiumDBEntitiesAdmin))
      {
        <td class="bx--table-column-menu">
          <div data-overflow-menu role="menu" tabindex="0" aria-label="Overflow menu description" class="bx--overflow-menu">
            <svg focusable="false" preserveAspectRatio="xMidYMid meet" style="will-change: transform;" xmlns="http://www.w3.org/2000/svg" class="bx--overflow-menu__icon" width="16" height="16" viewBox="0 0 16 16" aria-hidden="true">
              <circle cx="8" cy="3" r="1"></circle><circle cx="8" cy="8" r="1"></circle><circle cx="8" cy="13" r="1"></circle>
            </svg>
            <ul class="bx--overflow-menu-options bx--overflow-menu--flip">
              <li class="bx--overflow-menu-options__option bx--table-row--menu-option">
                <button class="bx--overflow-menu-options__btn" onclick="location.href='@Url.Action("Edit", new {id = Model.Data[i].KeyId})'">
                  <div class="bx--overflow-menu-options__option-content">
                    <svg focusable="false" preserveAspectRatio="xMidYMid meet" style="will-change: transform;" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" aria-hidden="true">
                      <path d="M1 13H15V14H1zM12.7 4.5c.4-.4.4-1 0-1.4 0 0 0 0 0 0l-1.8-1.8c-.4-.4-1-.4-1.4 0 0 0 0 0 0 0L2 8.8V12h3.2L12.7 4.5zM10.2 2L12 3.8l-1.5 1.5L8.7 3.5 10.2 2zM3 11V9.2l5-5L9.8 6l-5 5H3z"></path>
                    </svg> Изменить
                  </div>
                </button>
              </li>
              <li class="bx--overflow-menu-options__option bx--table-row--menu-option">
                <button class="bx--overflow-menu-options__btn" data-modal-target="#modal-danger" onclick="showDeleteModal('Deleting an entity', 'Do you really want to delete this entity', () => deleteEntity(@Model.Data[i].KeyId))">
                  <div class="bx--overflow-menu-options__option-content">
                    <svg focusable="false" preserveAspectRatio="xMidYMid meet" style="will-change: transform;" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" aria-hidden="true">
                      <path d="M6 6H7V12H6zM9 6H10V12H9z"></path><path d="M2 3v1h1v10c0 .6.4 1 1 1h8c.6 0 1-.4 1-1V4h1V3H2zM4 14V4h8v10H4zM6 1H10V2H6z"></path>
                    </svg> Удалить
                  </div>
                </button>
              </li>
            </ul>
          </div>
        </td>
      }
    </tr>
  }
  </tbody>
</table>
<!-- Pagination -->
<partial name="Partail/CarbonUIComponents/Pagination" model="@Model.Pagination"/>
</div>